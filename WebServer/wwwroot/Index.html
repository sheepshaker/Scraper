<!doctype html>
<html>
<script src="js/angular.min.js"></script>
<script src="js/app/app.module.js"></script>
<script src="js/app/mainCtrl.js"></script>
<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/jquery.signalR-2.2.0.min.js"></script>
<script src="js/angular-signalr-hub.min.js"></script>
<script src="/signalr/hubs"></script>
<script src="js/masonry.pkgd.min.js"></script>
  <head>
<script>


var app = angular.module('myApp', []);
app.controller('GetAllScrapes', function($scope, $http, $rootScope) {
  $rootScope.scrapes = [];
    $http.get('http://82.14.248.46:8010/api/Scraper')
  .then(function(response) {
      $rootScope.scrapes = response.data;
	//alert($rootScope.scrapes);
  });
}
);

app.controller('TitleController', function($scope){ $scope.title = "Scrapes:"; });

app.controller("AddNewScrape", function ($scope, $http) {

        $scope.SendData = function () {
	    
            var config = {
                headers : {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;'
                }
            }

            $http.post("http://82.14.248.46:8010/api/Scraper","=" + $scope.formUrl, config)
            .then(function (response) {
                $scope.PostDataResponse = response.data;
            });
        };
    });

app.controller("DeleteAllScrapes", function ($scope, $http, $rootScope) {

        $scope.SendData = function () {
	    
            $http.delete("http://82.14.248.46:8010/api/Scraper")
            .then(function (response) {
		//$rootScope.scrapes.length = 0;
                $scope.PostDataResponse = response.data;
            });
        };
    });

app.controller("signalrController", function ($rootScope){

// Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '</li>');
            };

        chat.client.broadcastTime = function (message) {
                // Add the message to the page.
                //$('#discussion').append('<li><strong>' + htmlEncode(message) + '</li>');
            };
	
	chat.client.broadcastDeleteAll = function () {
                // Add the message to the page.
        	//alert("delete all");
		console.log("delete all");
		$rootScope.scrapes.length = 0;
	    };

	chat.client.broadcastScrapeAdded = function (scrape) {
                // Add the message to the page.
        	//alert(scrape);
		$rootScope.scrapes.push(scrape);
	    };

    	chat.client.broadcastScrapeUpdate = function (scrapeArray) {
                // Add the message to the page.
		//var cohnt =  JSON.parse(scrapeArray).length
        	//console.log("got an update " + scrapeArray + " count = " + cohnt);
		//var scrapez = $rootScope.scrapes;
		//console.log(scrapez[0]);
		for(i=0; i < scrapeArray.length; i++)
		{
		    for(j=0; j < $rootScope.scrapes.length; j++)
		    {
			if(scrapeArray[i].Id == $rootScope.scrapes[j].Id)
			{
			    //$rootScope.scrapes[j]['Progress'] = "xxx";
			    //console.log("updated " + j + " from " + $rootScope.scrapes[j].Progress + " to " + scrapeArray[i].Progress);
			    $rootScope.scrapes[j] = scrapeArray[i];
			    //$rootScope.scrapes.splice(j, 1, scrapeArray[i]);
			}
		    }
		}

		$rootScope.$apply();
		/*
		for(update in scrapeArray)
		{
		    //var x = JSON.parse(update)
		    console.log(update);
		    for(s in $rootScope.scrapes)
		    {
			//console.log("updated" + s);
			if(s.Id == update.Id)
			{
			    //console.log("updated" + s.Id);
			    s.Progress = update.Progress;
			}
		    }
		    //$rootScope.scrapes[scrape.Id
		}*/
		//alert(scrapeArray);
		//$rootScope.scrapes.push(scrape);
	    };

            // Get the user name and store it to prepend to messages.
            $('#displayname').val(/*prompt('Enter your name:', '')*/"jacko");
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
});

function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

</script>
<LINK REL=StyleSheet HREF="css/masonry-grid.css" TYPE="text/css">
<LINK REL=StyleSheet HREF="css/progressbar.css" TYPE="text/css">

  </head>
  <body ng-app="myApp">
<div ng-controller="signalrController"></div>
<div ng-controller="AddNewScrape">
    <p>Url: <input type="text" name="formUrl" ng-model="formUrl" required /></p>
    <button ng-click="SendData()">Submit</button>
    <hr />
    {{ PostDataResponse }}
</div>
<div ng-controller="DeleteAllScrapes">
    <button ng-click="SendData()">Delete all</button>
    <hr />
    {{ PostDataResponse }}
</div>

<div class="grid" ng-controller="GetAllScrapes">
    <div ng-repeat="model in scrapes">
        <div ng-if="!model.IsCompleted" class="grid-item grid-item--width2 grid-item--height3">
	    <!--<progress value="{{model.Progress}}" max="100">hello</progress>-->
	    <div id="progress" class="graph">
		<div id="bar" style="width:{{model.Progress}}%">
		    <p>{{model.Progress}}%</p>
		</div>
	    </div>
	    <p>Name {{model.Name}}</p>
	    <p>Url {{model.Url}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Speed {{model.DownloadSpeed}}</p>
	    <p>Downloaded {{model.DownloadedBytes}} / {{model.DownloadSize}}</p>
	    <p>Eta {{model.Eta}}</p>
	    
	</div>
	<div ng-if="model.IsCompleted" class="grid-item-completed grid-item--width2 grid-item--height3">
	    <p>Name {{model.Name}}</p>
	    <p>Url {{model.Url}}</p>
	    <p>Progress {{model.Progress}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Downloaded {{model.DownloadedBytes}} / {{model.DownloadSize}}</p>
	    <p>Completed {{model.DateCompleted}}</p>
	    <p>Elapsed {{model.Elapsed}}</p>
	</div>
    </div>
</div>

<!--
<div ng-controller="GetAllScrapes">
    <div ng-repeat="model in scrapes">
	<div ng-if="!model.DateCompleted" >
	    <p>Name {{model.Name}}</p>
	    <p>Url {{model.Url}}</p>
	    <p>Progress {{model.Progress}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Eta {{model.Eta}}</p>
	</div>
    </div>
</div>
-->
    <h2 id="username">Chat</h2>
    <div id="userStat"> </div> 
    <div class="container">
        <input type="text" id="message"/>
        <input type="button" id="sendmessage" value="Send"/>
        
	<input type="hidden" id="displayname"/>
        <ul id="discussion"></ul>
        <ul id="time"></ul>
    </div>
<script>



</script>
  </body>
</html>



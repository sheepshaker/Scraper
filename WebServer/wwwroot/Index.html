<!doctype html>
<html>
<script src="js/angular.min.js"></script>
<script src="js/app/app.module.js"></script>
<script src="js/app/mainCtrl.js"></script>
<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/jquery.signalR-2.2.0.min.js"></script>
<script src="js/angular-signalr-hub.min.js"></script>
<script src="/signalr/hubs"></script>
<script src="js/masonry.pkgd.min.js"></script>
  <head>
<script>


var app = angular.module('myApp', []);
app.controller('GetAllScrapes', function($scope, $http, $rootScope) {
  $rootScope.scrapes = [];
    $http.get('http://82.14.248.46:8010/api/Scraper')
  .then(function(response) {
      $rootScope.scrapes = response.data;
	//alert($rootScope.scrapes);
  });
}
);

app.controller('TitleController', function($scope){ $scope.title = "Scrapes:"; });

app.controller("AddNewScrape", function ($scope, $http) {

        $scope.SendData = function () {
	    
            var config = {
                headers : {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8;'
                }
            }

            $http.post("http://82.14.248.46:8010/api/Scraper","=" + $scope.formUrl, config)
            .then(function (response) {
                $scope.PostDataResponse = response.data;
            });
        };
    });

app.controller("DeleteAllScrapes", function ($scope, $http, $rootScope) {

        $scope.SendData = function () {
	    
            $http.delete("http://82.14.248.46:8010/api/Scraper")
            .then(function (response) {
		//$rootScope.scrapes.length = 0;
                $scope.PostDataResponse = response.data;
            });
        };
    });

app.controller("signalrController", function ($rootScope){

// Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '</li>');
            };

        chat.client.broadcastTime = function (message) {
                // Add the message to the page.
                //$('#discussion').append('<li><strong>' + htmlEncode(message) + '</li>');
            };
	
	chat.client.broadcastDeleteAll = function () {
                // Add the message to the page.
        	//alert("delete all");
		console.log("delete all");
		$rootScope.scrapes.length = 0;
	    };

	chat.client.broadcastScrapeAdded = function (scrape) {
                // Add the message to the page.
        	//alert(scrape);
		$rootScope.scrapes.push(scrape);
	    };
/*
	chat.client.broadcastScraperCompleted = function (scrape) {
	    for(j=0; j < $rootScope.scrapes.length; j++)
	    {
		if(scrape.Id == $rootScope.scrapes[j].Id)
		{
		    $rootScope.scrapes[j] = scrape;
		}
	    }

	    $rootScope.$apply();
	};

	chat.client.broadcastScraperFailed = function (scrape) {
	    for(j=0; j < $rootScope.scrapes.length; j++)
	    {
		if(scrape.Id == $rootScope.scrapes[j].Id)
		{
		    $rootScope.scrapes[j] = scrape;
		}
	    }

	    $rootScope.$apply();
	};*/

	chat.client.broadcastScrapeUpdate = function (scrape) {
	    for(j=0; j < $rootScope.scrapes.length; j++)
	    {
		if(scrape.Id == $rootScope.scrapes[j].Id)
		{
		    $rootScope.scrapes[j] = scrape;
		}
	    }

	    $rootScope.$apply();
	};

    	chat.client.broadcastScrapesUpdate = function (scrapeArray) {
		for(i=0; i < scrapeArray.length; i++)
		{
		    for(j=0; j < $rootScope.scrapes.length; j++)
		    {
			if(scrapeArray[i].Id == $rootScope.scrapes[j].Id)
			{
			    $rootScope.scrapes[j] = scrapeArray[i];
			}
		    }
		}

		$rootScope.$apply();
	    };

            // Get the user name and store it to prepend to messages.
            $('#displayname').val(/*prompt('Enter your name:', '')*/"jacko");
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
});

function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

</script>
<LINK REL=StyleSheet HREF="css/masonry-grid.css" TYPE="text/css">
<LINK REL=StyleSheet HREF="css/progressbar.css" TYPE="text/css">
<LINK REL=StyleSheet HREF="css/spinner.css" TYPE="text/css">

  </head>
  <body ng-app="myApp">
<div ng-controller="signalrController"></div>
<div ng-controller="AddNewScrape">
    <p>Url: <input type="text" name="formUrl" ng-model="formUrl" required /></p>
    <button ng-click="SendData()">Submit</button>
    <hr />
    {{ PostDataResponse }}
</div>
<div ng-controller="DeleteAllScrapes">
    <button ng-click="SendData()">Delete all</button>
    <hr />
    {{ PostDataResponse }}
</div>

<div class="grid" ng-controller="GetAllScrapes">
    <div ng-repeat="model in scrapes">	
	<div ng-if="model.IsScrapingInProgress" class="grid-item-is-scraping-in-progress grid-item--width2 grid-item--height3">
	    <div class="loader"></div>
	    <p>Input Url {{model.InputUrl}}</p>
	    <p>Started {{model.DateStarted}}</p>
	</div>
	<div ng-if="model.IsScrapingFailed" class="grid-item-scraping-failed grid-item--width2 grid-item--height3">
	    <p>Input Url {{model.InputUrl}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Error: {{model.ScrapingFailedMessage}}</p>
	</div>
        <div ng-if="model.IsDownloadInProgress" class="grid-item-download-in-progress grid-item--width2 grid-item--height3">
	    <div id="progress" class="graph">
		<div id="bar" style="width:{{model.Progress}}%">
		    <p>{{model.Progress}}%</p>
		</div>
	    </div>
	    <h1>{{model.Name}}</h1>
	    <a href="{{model.DownloadUrl}}">Download Url</a>
	    <a href="{{model.InputUrl}}">Input Url</a>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Speed {{model.DownloadSpeed}}</p>
	    <p>Downloaded {{model.DownloadedBytes}} / {{model.DownloadSize}}</p>
	    <p>Eta {{model.Eta}}</p>
	</div>
	<div ng-if="model.IsDownloadCompleted" class="grid-item-download-completed grid-item--width2 grid-item--height3">
	    <p>Name {{model.Name}}</p>
	    <p>Url {{model.Url}}</p>
	    <p>Progress {{model.Progress}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Downloaded {{model.DownloadedBytes}} / {{model.DownloadSize}}</p>
	    <p>Completed {{model.DateCompleted}}</p>
	    <p>Elapsed {{model.Elapsed}}</p>
	</div>
	<div ng-if="model.IsDownloadCanceled" class="grid-item-download-canceled grid-item--width2 grid-item--height3">
	    <p>Name {{model.Name}}</p>
	    <p>Url {{model.Url}}</p>
	    <p>Progress {{model.Progress}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Downloaded {{model.DownloadedBytes}} / {{model.DownloadSize}}</p>
	    <p>Completed {{model.DateCompleted}}</p>
	    <p>Elapsed {{model.Elapsed}}</p>
	</div>
	<div ng-if="model.IsDownloadFailed" class="grid-item-download-failed grid-item--width2 grid-item--height3">
	    <p>Name {{model.Name}}</p>
	    <p>Url {{model.Url}}</p>
	    <p>Progress {{model.Progress}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Downloaded {{model.DownloadedBytes}} / {{model.DownloadSize}}</p>
	    <p>Completed {{model.DateCompleted}}</p>
	    <p>Elapsed {{model.Elapsed}}</p>
	</div>
    </div>
</div>

<!--
<div ng-controller="GetAllScrapes">
    <div ng-repeat="model in scrapes">
	<div ng-if="!model.DateCompleted" >
	    <p>Name {{model.Name}}</p>
	    <p>Url {{model.Url}}</p>
	    <p>Progress {{model.Progress}}</p>
	    <p>Started {{model.DateStarted}}</p>
	    <p>Eta {{model.Eta}}</p>
	</div>
    </div>
</div>
-->
    <h2 id="username">Chat</h2>
    <div id="userStat"> </div> 
    <div class="container">
        <input type="text" id="message"/>
        <input type="button" id="sendmessage" value="Send"/>
        
	<input type="hidden" id="displayname"/>
        <ul id="discussion"></ul>
        <ul id="time"></ul>
    </div>
<script>



</script>
  </body>
</html>


